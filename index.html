<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Chatroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            orderBy, 
            onSnapshot,
            serverTimestamp,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCvg7VUDzv2XPgsy_cUvZz2O9YilWlJhTw",
            authDomain: "my-chatroom-44ca8.firebaseapp.com",
            projectId: "my-chatroom-44ca8",
            storageBucket: "my-chatroom-44ca8.firebasestorage.app",
            messagingSenderId: "193127570662",
            appId: "1:193127570662:web:277c5064ce4e859f80af27",
            measurementId: "G-6T50F0DLL6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.firebase = {
            auth,
            db,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            collection,
            addDoc,
            query,
            orderBy,
            onSnapshot,
            serverTimestamp,
            Timestamp
        };

        console.log('Firebase initialized successfully');
    </script>
    <style>
        .messages-container {
            scrollbar-width: thin;
            scrollbar-color: #4B5563 #1F2937;
        }
        .messages-container::-webkit-scrollbar {
            width: 6px;
        }
        .messages-container::-webkit-scrollbar-track {
            background: #1F2937;
        }
        .messages-container::-webkit-scrollbar-thumb {
            background-color: #4B5563;
            border-radius: 3px;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-animation {
            animation: messageSlide 0.3s ease-out;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gray-800 p-4 shadow-md">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-400">Firebase Chatroom</h1>
            <div id="userInfo" class="hidden">
                <span id="userEmail" class="mr-4"></span>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto p-4 flex flex-col">
        <!-- Authentication Section -->
        <section id="authSection" class="max-w-md mx-auto w-full mt-8 bg-gray-800 p-6 rounded-xl shadow-lg fade-in">
            <h2 class="text-xl font-semibold mb-6 text-center">Join the Chatroom</h2>
            
            <!-- Tabs for Login/Register -->
            <div class="flex mb-6 border-b border-gray-700">
                <button id="loginTab" class="flex-1 py-2 font-medium text-center border-b-2 border-blue-500 text-blue-400">
                    Login
                </button>
                <button id="registerTab" class="flex-1 py-2 font-medium text-center text-gray-400 hover:text-white transition duration-200">
                    Register
                </button>
            </div>
            
            <!-- Login Form -->
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginEmail" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="loginEmail" required 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           value="test@example.com">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="loginPassword" required 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                           value="123456">
                </div>
                <button type="submit" id="loginBtn"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition duration-200 font-medium flex justify-center items-center">
                    <span id="loginText">Sign In</span>
                    <div id="loginSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white ml-2"></div>
                </button>
            </form>
            
            <!-- Register Form -->
            <form id="registerForm" class="space-y-4 hidden">
                <div>
                    <label for="registerEmail" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="registerEmail" required 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="registerPassword" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="registerPassword" required 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-400 mt-1">Password must be at least 6 characters</p>
                </div>
                <div>
                    <label for="confirmPassword" class="block text-sm font-medium mb-1">Confirm Password</label>
                    <input type="password" id="confirmPassword" required 
                           class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" id="registerBtn"
                        class="w-full bg-green-500 hover:bg-green-600 text-white py-2 rounded-lg transition duration-200 font-medium flex justify-center items-center">
                    <span id="registerText">Create Account</span>
                    <div id="registerSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white ml-2"></div>
                </button>
            </form>
            
            <!-- Status Message -->
            <div id="authStatus" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
        </section>

        <!-- Chat Section -->
        <section id="chatSection" class="hidden flex-grow flex flex-col max-w-4xl mx-auto w-full mt-8 bg-gray-800 rounded-xl shadow-lg overflow-hidden">
            <!-- Messages Container -->
            <div id="messagesContainer" class="flex-grow p-4 overflow-y-auto messages-container bg-gray-900">
                <div class="text-center text-gray-500 py-8">
                    Welcome to the chatroom! Start a conversation.
                </div>
            </div>
            
            <!-- Message Input -->
            <div class="p-4 border-t border-gray-700 bg-gray-800">
                <form id="messageForm" class="flex space-x-2">
                    <input type="text" id="messageInput" placeholder="Type your message..." required 
                           class="flex-grow px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition duration-200 font-medium">
                        Send
                    </button>
                </form>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 p-4 text-center text-gray-400 text-sm">
        Firebase Chatroom &copy; 2023
    </footer>

    <script>
        // DOM Elements
        const authSection = document.getElementById('authSection');
        const chatSection = document.getElementById('chatSection');
        const userInfo = document.getElementById('userInfo');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        
        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        
        const authStatus = document.getElementById('authStatus');
        const loginBtn = document.getElementById('loginBtn');
        const loginText = document.getElementById('loginText');
        const loginSpinner = document.getElementById('loginSpinner');
        const registerBtn = document.getElementById('registerBtn');
        const registerText = document.getElementById('registerText');
        const registerSpinner = document.getElementById('registerSpinner');

        console.log('DOM elements loaded');

        // Initialize Firebase Auth State Listener
        function initializeAuthListener() {
            console.log('Initializing auth state listener...');
            
            window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                console.log('Auth state changed:', user);
                
                if (user) {
                    // User is signed in
                    console.log('User signed in:', user.email);
                    showChatInterface(user);
                } else {
                    // User is signed out
                    console.log('User signed out');
                    showAuthInterface();
                }
            }, (error) => {
                console.error('Auth state listener error:', error);
            });
        }

        function showChatInterface(user) {
            console.log('Showing chat interface for user:', user.email);
            authSection.classList.add('hidden');
            chatSection.classList.remove('hidden');
            userInfo.classList.remove('hidden');
            userEmail.textContent = user.email;
            loadMessages();
            
            // Add fade-in effect
            setTimeout(() => {
                chatSection.classList.add('fade-in');
            }, 10);
        }

        function showAuthInterface() {
            console.log('Showing auth interface');
            authSection.classList.remove('hidden');
            chatSection.classList.add('hidden');
            userInfo.classList.add('hidden');
            messagesContainer.innerHTML = '<div class="text-center text-gray-500 py-8">Welcome to the chatroom! Start a conversation.</div>';
            
            // Clear forms
            loginForm.reset();
            registerForm.reset();
            hideStatus();
        }

        // Tab Switching
        loginTab.addEventListener('click', () => {
            loginTab.classList.add('border-blue-500', 'text-blue-400');
            loginTab.classList.remove('text-gray-400');
            registerTab.classList.remove('border-blue-500', 'text-blue-400');
            registerTab.classList.add('text-gray-400');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            hideStatus();
        });
        
        registerTab.addEventListener('click', () => {
            registerTab.classList.add('border-blue-500', 'text-blue-400');
            registerTab.classList.remove('text-gray-400');
            loginTab.classList.remove('border-blue-500', 'text-blue-400');
            loginTab.classList.add('text-gray-400');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            hideStatus();
        });
        
        // Authentication Functions
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Login form submitted');
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showStatus('Please fill in all fields', 'error', true);
                return;
            }
            
            // Show loading state
            setLoadingState(loginBtn, loginText, loginSpinner, true);
            
            try {
                console.log('Attempting login for:', email);
                const userCredential = await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                console.log('Login successful:', userCredential.user);
                showStatus('Login successful!', 'success');
                
                // The auth state listener should automatically handle the UI transition
            } catch (error) {
                console.error('Login error:', error);
                handleAuthError(error, 'login');
            } finally {
                setLoadingState(loginBtn, loginText, loginSpinner, false);
            }
        });
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('Register form submitted');
            
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Basic validation
            if (!email || !password || !confirmPassword) {
                showStatus('Please fill in all fields', 'error', true);
                return;
            }
            
            if (password.length < 6) {
                showStatus('Password must be at least 6 characters long!', 'error', true);
                return;
            }
            
            if (password !== confirmPassword) {
                showStatus('Passwords do not match!', 'error', true);
                return;
            }
            
            // Show loading state
            setLoadingState(registerBtn, registerText, registerSpinner, true);
            
            try {
                console.log('Attempting registration for:', email);
                const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                console.log('Registration successful:', userCredential.user);
                showStatus('Account created successfully!', 'success');
                
                // The auth state listener should automatically handle the UI transition
            } catch (error) {
                console.error('Registration error:', error);
                handleAuthError(error, 'register');
            } finally {
                setLoadingState(registerBtn, registerText, registerSpinner, false);
            }
        });
        
        logoutBtn.addEventListener('click', async () => {
            console.log('Logout clicked');
            try {
                await window.firebase.signOut(window.firebase.auth);
                console.log('Logout successful');
            } catch (error) {
                console.error('Logout error:', error);
            }
        });
        
        // Message Functions
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            
            if (message && window.firebase.auth.currentUser) {
                try {
                    await window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'messages'), {
                        text: message,
                        user: window.firebase.auth.currentUser.email,
                        timestamp: window.firebase.serverTimestamp()
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error('Error sending message:', error);
                    showStatus('Failed to send message', 'error');
                }
            }
        });
        
        function loadMessages() {
            console.log('Loading messages...');
            const q = window.firebase.query(
                window.firebase.collection(window.firebase.db, 'messages'),
                window.firebase.orderBy('timestamp', 'asc')
            );
            
            window.firebase.onSnapshot(q, (querySnapshot) => {
                console.log('Messages updated, count:', querySnapshot.size);
                messagesContainer.innerHTML = '';
                
                if (querySnapshot.size === 0) {
                    messagesContainer.innerHTML = '<div class="text-center text-gray-500 py-8">No messages yet. Start the conversation!</div>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const message = doc.data();
                    displayMessage(message);
                });
                
                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, (error) => {
                console.error('Error loading messages:', error);
                showStatus('Failed to load messages', 'error');
            });
        }
        
        function displayMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mb-4 message-animation';
            
            const isCurrentUser = window.firebase.auth.currentUser && 
                                 message.user === window.firebase.auth.currentUser.email;
            
            // Properly handle Firestore timestamp
            let timestampText = 'Sending...';
            if (message.timestamp) {
                // Check if it's a Firestore Timestamp object
                if (message.timestamp.toDate) {
                    timestampText = message.timestamp.toDate().toLocaleTimeString();
                } else if (message.timestamp instanceof Date) {
                    timestampText = message.timestamp.toLocaleTimeString();
                } else if (typeof message.timestamp === 'string') {
                    timestampText = new Date(message.timestamp).toLocaleTimeString();
                }
            }
            
            messageDiv.innerHTML = `
                <div class="flex ${isCurrentUser ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-xs lg:max-w-md rounded-lg p-3 ${isCurrentUser ? 'bg-blue-600 rounded-br-none' : 'bg-gray-700 rounded-bl-none'}">
                        <div class="text-xs text-gray-300 mb-1">${message.user}</div>
                        <div class="text-white">${message.text}</div>
                        <div class="text-xs text-gray-400 mt-1 text-right">
                            ${timestampText}
                        </div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
        }
        
        // Utility Functions
        function setLoadingState(button, text, spinner, isLoading) {
            if (isLoading) {
                button.disabled = true;
                text.textContent = button.id === 'loginBtn' ? 'Signing In...' : 'Creating Account...';
                spinner.classList.remove('hidden');
            } else {
                button.disabled = false;
                text.textContent = button.id === 'loginBtn' ? 'Sign In' : 'Create Account';
                spinner.classList.add('hidden');
            }
        }
        
        function handleAuthError(error, type) {
            console.log('Handling auth error:', error.code);
            
            let message = '';
            
            switch (error.code) {
                case 'auth/email-already-in-use':
                    message = 'This email is already registered. Please login instead.';
                    // Switch to login tab if trying to register
                    if (type === 'register') {
                        setTimeout(() => loginTab.click(), 2000);
                    }
                    break;
                case 'auth/user-not-found':
                    message = 'No account found with this email. Please register first.';
                    // Switch to register tab if trying to login
                    if (type === 'login') {
                        setTimeout(() => registerTab.click(), 2000);
                    }
                    break;
                case 'auth/wrong-password':
                    message = 'Incorrect password. Please try again.';
                    break;
                case 'auth/invalid-email':
                    message = 'Invalid email address format.';
                    break;
                case 'auth/weak-password':
                    message = 'Password is too weak. Please use at least 6 characters.';
                    break;
                case 'auth/network-request-failed':
                    message = 'Network error. Please check your connection.';
                    break;
                case 'auth/too-many-requests':
                    message = 'Too many failed attempts. Please try again later.';
                    break;
                default:
                    message = `Authentication failed: ${error.message}`;
            }
            
            showStatus(message, 'error', true);
        }
        
        function showStatus(message, type, shake = false) {
            authStatus.textContent = message;
            authStatus.className = `mt-4 p-3 rounded-lg text-sm ${type === 'success' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}`;
            authStatus.classList.remove('hidden');
            
            if (shake) {
                authStatus.classList.add('shake');
                setTimeout(() => authStatus.classList.remove('shake'), 500);
            }
            
            // Clear status after 5 seconds for errors, 3 for success
            setTimeout(() => {
                if (!authStatus.classList.contains('hidden')) {
                    hideStatus();
                }
            }, type === 'success' ? 3000 : 5000);
        }
        
        function hideStatus() {
            authStatus.classList.add('hidden');
            authStatus.textContent = '';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded');
            initializeAuthListener();
            
            // Check initial auth state
            const currentUser = window.firebase.auth.currentUser;
            console.log('Initial auth state:', currentUser);
            
            if (currentUser) {
                showChatInterface(currentUser);
            } else {
                showAuthInterface();
            }
        });
    </script>
</body>
</html>